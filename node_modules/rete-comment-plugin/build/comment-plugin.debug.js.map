{"version":3,"file":"comment-plugin.debug.js","sources":["../src/draggable.js","../src/comment.js","../src/utils.js","../src/frame-comment.js","../src/inline-comment.js","../src/manager.js","../src/index.js"],"sourcesContent":["export default class Draggable {\n\n    constructor(el, onStart = () => {}, onTranslate = () => {}, onDrag = () => {}) {\n        this.mouseStart = null;\n\n        this.el = el;\n        this.onStart = onStart;\n        this.onTranslate = onTranslate;\n        this.onDrag = onDrag;\n\n        this.initEvents(el);\n    }\n\n    initEvents(el) {\n        el.addEventListener('mousedown', this.down.bind(this));\n        window.addEventListener('mousemove', this.move.bind(this));\n        window.addEventListener('mouseup', this.up.bind(this));\n\n        el.addEventListener('touchstart', this.down.bind(this));\n        window.addEventListener('touchmove', this.move.bind(this), {\n            passive: false\n        });\n        window.addEventListener('touchend', this.up.bind(this));\n    }\n\n    getCoords(e) {\n        const props = e.touches ? e.touches[0] : e;\n\n        return [props.pageX, props.pageY];\n    }\n\n    down(e) {\n        e.stopPropagation();\n        this.mouseStart = this.getCoords(e);\n\n        this.onStart();\n    }\n\n    move(e) {\n        if (!this.mouseStart) return;\n        e.preventDefault();\n        e.stopPropagation();\n\n        let [x, y] = this.getCoords(e);\n        let delta = [x - this.mouseStart[0], y - this.mouseStart[1]];\n        let zoom = this.el.getBoundingClientRect().width / this.el.offsetWidth;\n\n        this.onTranslate(delta[0] / zoom, delta[1] / zoom);\n    }\n\n    up() {\n        if (this.mouseStart) {\n            this.onDrag();\n        }\n\n        this.mouseStart = null;\n    }\n}","import Draggable from './draggable';\n\nexport default class Comment {\n    constructor(text, editor) {\n        this.editor = editor;\n        this.text = text;\n        this.scale = 1;\n        this.x = 0;\n        this.y = 0;\n        this.dragPosition = [0, 0];\n        this.links = [];\n \n        this.el = document.createElement('div');\n        this.el.tabIndex = 1;\n        this.el.addEventListener('contextmenu', this.onClick.bind(this));\n        this.el.addEventListener('focus', this.onFocus.bind(this));\n        this.el.addEventListener('blur', this.onBlur.bind(this));\n    \n        new Draggable(this.el, () => this.onStart(), (dx, dy) => this.onTranslate(dx, dy));\n        this.update();\n    }\n\n    linkTo(ids) {\n        this.links = ids || [];\n    }\n\n    linkedTo(node) {\n        return this.links.includes(node.id);\n    }\n\n    k() {\n        return 1;\n    }\n\n    onClick(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        let newText = prompt('Comment', this.text);\n\n        if (newText) {\n            this.text = newText\n            this.update();\n        }\n    }\n\n    onFocus() {\n        this.scale = Math.max(1, 1 / this.k());\n        this.update();\n        this.editor.trigger('commentselected', this)\n    }\n\n    focused() {\n        return document.activeElement === this.el;\n    }\n\n    onBlur() {\n        this.scale = 1;\n        this.update()\n    }\n\n    blur() {\n        this.el.blur();\n    }\n\n    onStart() {\n        this.dragPosition = [this.x, this.y];\n    }\n\n    onTranslate (dx, dy) {\n        const [x, y] = this.dragPosition;\n\n        this.x = x + this.scale * dx;\n        this.y = y + this.scale * dy;\n        \n        this.update();\n    }\n\n    update() {\n        this.el.innerText = this.text;\n        this.el.style.transform = `translate(${this.x}px, ${this.y}px) scale(${this.scale})`;\n    }\n\n    toJSON() {\n        return {\n            text: this.text,\n            position: [ this.x, this.y ],\n            links: this.links\n        }\n    }\n}","const min = (arr) => arr.length === 0 ? 0 : Math.min(...arr);\nconst max = (arr) => arr.length === 0 ? 0 : Math.max(...arr);\n\nexport function intersectRect(r1, r2) {\n    return !(\n        r2.left > r1.right || \n        r2.right < r1.left || \n        r2.top > r1.bottom ||\n        r2.bottom < r1.top\n    );\n}\n\nexport function containsRect(r1, r2) {\n    return (\n        r2.left > r1.left && \n        r2.right < r1.right && \n        r2.top > r1.top &&\n        r2.bottom < r1.bottom\n    );\n}\n\nexport function nodesBBox(editor, nodes, margin) {\n    const left = min(nodes.map(node => node.position[0])) - margin;\n    const top = min(nodes.map(node => node.position[1])) - margin;\n    const right = max(nodes.map(node => node.position[0] + editor.view.nodes.get(node).el.clientWidth)) + 2 * margin;\n    const bottom = max(nodes.map(node => node.position[1] + editor.view.nodes.get(node).el.clientHeight)) + 2 * margin;\n    \n    return {\n        left,\n        right,\n        top,\n        bottom,\n        width: Math.abs(left - right),\n        height: Math.abs(top - bottom),\n        getCenter: () => {\n            return [\n                (left + right) / 2,\n                (top + bottom) / 2\n            ];\n        }\n    };\n}","import Comment from './comment';\nimport { containsRect } from './utils';\n\nexport default class FrameComment extends Comment {\n    constructor(text, editor) {\n        super(text, editor);\n        \n        this.width = 0;\n        this.height = 0;\n        this.links = [];\n        this.el.className = 'frame-comment';\n    }\n\n    linkedNodesView() {\n        return this.links\n            .map(id => this.editor.nodes.find(n => n.id === id))\n            .map(node => this.editor.view.nodes.get(node));\n    }\n\n    onStart() {\n        super.onStart();\n        this.linkedNodesView().map(nodeView => nodeView.onStart())\n    }\n\n    onTranslate(dx, dy) {\n        super.onTranslate(dx, dy);\n        this.linkedNodesView().map(nodeView => nodeView.onDrag(dx, dy))\n    }\n\n    isContains(node) {\n        const commRect = this.el.getBoundingClientRect();\n        const view = this.editor.view.nodes.get(node);\n    \n        return containsRect(commRect, view.el.getBoundingClientRect());\n    }\n\n    update() {\n        super.update();\n\n        this.el.style.width = this.width+'px';\n        this.el.style.height = this.height+'px';\n    }\n\n    toJSON() {\n        return {\n            ...super.toJSON(),\n            type: 'frame',\n            width: this.width,\n            height: this.height\n        }\n    }\n}","import Comment from './comment';\nimport { intersectRect } from './utils';\n\nexport default class InlineComment extends Comment {\n    constructor(text, editor) {\n        super(text, editor);\n        \n        this.el.className = 'inline-comment';\n        this.el.addEventListener('mouseup', this.onDrag.bind(this));\n    }\n\n    onDrag() {\n        const intersection = this.getIntersectNode();\n\n        this.linkTo(intersection ? [intersection.node.id] : []);\n    }\n\n    getIntersectNode() {\n        const commRect = this.el.getBoundingClientRect();\n\n        return Array.from(this.editor.view.nodes)\n            .map(([node, view]) => {\n                return { node, rect: view.el.getBoundingClientRect() };\n            })\n            .find(({ rect }) => {\n                return intersectRect(commRect, rect);\n            });\n    }\n\n    offset(dx, dy) {\n        this.x += dx;\n        this.y += dy;\n        this.update();\n    } \n\n    toJSON() {\n        return {\n            ...super.toJSON(),\n            type: 'inline'\n        }\n    }\n}","import FrameComment from './frame-comment';\nimport InlineComment from './inline-comment';\n\nexport default class CommentManager {\n    constructor(editor) {\n        this.editor = editor;\n        this.comments = [];\n\n        editor.on('zoomed', () => {\n            this.comments.map(c => c.blur.call(c));\n        });\n    }\n\n    addInlineComment(text, [ x, y ], links = []) {\n        let comment = new InlineComment(text, this.editor);\n\n        comment.k = () => this.editor.view.area.transform.k;\n        comment.x = x;\n        comment.y = y;\n        comment.linkTo(links);\n\n        this.addComment(comment);\n    }\n\n    addFrameComment(text, [ x, y ], links = [], width = 0, height = 0) {\n        let comment = new FrameComment(text, this.editor);\n\n        comment.x = x;\n        comment.y = y;\n        comment.width = width;\n        comment.height = height;\n        comment.linkTo(links);\n        \n        this.addComment(comment);\n    }\n\n    addComment(comment) {\n        comment.update();\n        this.comments.push(comment);\n\n        this.editor.view.area.appendChild(comment.el);\n        this.editor.trigger('commentcreated', comment);\n    }\n\n    deleteComment(comment) {\n        this.editor.view.area.removeChild(comment.el);\n        this.comments.splice(this.comments.indexOf(comment), 1);\n\n        this.editor.trigger('commentremoved', comment);\n    }\n\n    deleteFocusedComment() {\n        const focused = this.comments.find(c => c.focused());\n        \n        if (focused)\n            this.deleteComment(focused)\n    }\n\n    toJSON() {\n        return this.comments.map(c => c.toJSON())\n    }\n\n    fromJSON(list) {\n        [...this.comments].map(c => this.deleteComment(c));\n        list.map(item => {\n            if (item.type === 'frame') {\n                this.addFrameComment(item.text, item.position, item.links, item.width, item.height)\n            } else {\n                this.addInlineComment(item.text, item.position, item.links);\n            }\n        });\n    }\n}","import './style.sass';\nimport CommentManager from './manager';\nimport FrameComment from './frame-comment';\nimport InlineComment from './inline-comment';\nimport { nodesBBox } from './utils';\n\nfunction install(editor, { margin = 30 }) {\n    editor.bind('commentselected');\n    editor.bind('commentcreated');\n    editor.bind('commentremoved');\n\n    const manager = new CommentManager(editor);\n\n    window.addEventListener('keydown', function handleKey(e) {\n\n        if (e.code === 'KeyF' && e.shiftKey) {\n            const ids = editor.selected.list.map(node => node.id);\n            const nodes = ids.map(id => editor.nodes.find(n => n.id === id));\n            const { left, top, width, height } = nodesBBox(editor, nodes, margin);\n\n            manager.addFrameComment('...', [ left, top ], ids, width, height);\n        } else if (e.code === 'KeyC' && e.shiftKey) {\n            const position = Object.values(editor.view.area.mouse);\n\n            manager.addInlineComment('...', position);\n        } else if (e.code === 'Delete') {\n            manager.deleteFocusedComment();\n        }\n    });\n\n    editor.on('nodetranslated', ({ node, prev }) => {\n        const dx = node.position[0] - prev[0];\n        const dy = node.position[1] - prev[1];\n\n        manager.comments\n            .filter(comment => comment instanceof InlineComment)\n            .filter(comment => comment.linkedTo(node))\n            .map(comment => comment.offset(dx, dy));\n    });\n\n    editor.on('nodedraged', node => {\n        manager.comments\n            .filter(comment => comment instanceof FrameComment)\n            .filter(comment => {\n                const contains = comment.isContains(node);\n                const links = comment.links.filter(id => id !== node.id);\n\n                comment.links = contains ? [...links, node.id] : links;\n            });\n    });\n\n    editor.on('commentselected', () => {\n        const list = [...editor.selected.list];\n\n        editor.selected.clear();\n        list.map(node => node.update ? node.update() : null);\n    })\n\n    editor.on('export', data => {\n        data.comments = manager.toJSON();\n    });\n\n    editor.on('import', data => {\n        manager.fromJSON(data.comments || []);\n    });\n}\n\nexport default {\n    install\n}"],"names":["Draggable","constructor","el","onStart","onTranslate","onDrag","mouseStart","initEvents","addEventListener","down","bind","window","move","up","passive","getCoords","e","props","touches","pageX","pageY","stopPropagation","preventDefault","x","y","delta","zoom","getBoundingClientRect","width","offsetWidth","Comment","text","editor","scale","dragPosition","links","document","createElement","tabIndex","onClick","onFocus","onBlur","dx","dy","update","linkTo","ids","linkedTo","node","includes","id","k","newText","prompt","Math","max","trigger","focused","activeElement","blur","innerText","style","transform","toJSON","position","min","arr","length","intersectRect","r1","r2","left","right","top","bottom","containsRect","nodesBBox","nodes","margin","map","view","get","clientWidth","clientHeight","abs","height","getCenter","FrameComment","className","linkedNodesView","find","n","nodeView","isContains","commRect","type","InlineComment","intersection","getIntersectNode","Array","from","rect","offset","CommentManager","comments","on","c","call","addInlineComment","comment","area","addComment","addFrameComment","push","appendChild","deleteComment","removeChild","splice","indexOf","deleteFocusedComment","fromJSON","list","item","install","manager","handleKey","code","shiftKey","selected","Object","values","mouse","prev","filter","contains","clear","data"],"mappings":"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"}