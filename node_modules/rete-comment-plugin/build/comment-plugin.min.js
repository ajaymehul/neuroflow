/*!
* rete-comment-plugin v0.2.1 
* (c) 2019 Vitaliy Stoliarov 
* Released under the ISC license.
*/
!function(t){"use strict";var s,e=Object.prototype,c=e.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},o=n.iterator||"@@iterator",r=n.asyncIterator||"@@asyncIterator",i=n.toStringTag||"@@toStringTag",a="object"==typeof module,u=t.regeneratorRuntime;if(u)a&&(module.exports=u);else{(u=t.regeneratorRuntime=a?module.exports:{}).wrap=w;var h="suspendedStart",f="suspendedYield",d="executing",p="completed",m={},l={};l[o]=function(){return this};var v=Object.getPrototypeOf,y=v&&v(v(P([])));y&&y!==e&&c.call(y,o)&&(l=y);var g=O.prototype=k.prototype=Object.create(l);x.prototype=g.constructor=O,O.constructor=x,O[i]=x.displayName="GeneratorFunction",u.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===x||"GeneratorFunction"===(e.displayName||e.name))},u.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,O):(t.__proto__=O,i in t||(t[i]="GeneratorFunction")),t.prototype=Object.create(g),t},u.awrap=function(t){return{__await:t}},_(E.prototype),E.prototype[r]=function(){return this},u.AsyncIterator=E,u.async=function(t,e,n,r){var o=new E(w(t,e,n,r));return u.isGeneratorFunction(e)?o:o.next().then(function(t){return t.done?t.value:o.next()})},_(g),g[i]="Generator",g[o]=function(){return this},g.toString=function(){return"[object Generator]"},u.keys=function(n){var r=[];for(var t in n)r.push(t);return r.reverse(),function t(){for(;r.length;){var e=r.pop();if(e in n)return t.value=e,t.done=!1,t}return t.done=!0,t}},u.values=P,j.prototype={constructor:j,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=s,this.done=!1,this.delegate=null,this.method="next",this.arg=s,this.tryEntries.forEach(S),!t)for(var e in this)"t"===e.charAt(0)&&c.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=s)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(n){if(this.done)throw n;var r=this;function t(t,e){return i.type="throw",i.arg=n,r.next=t,e&&(r.method="next",r.arg=s),!!e}for(var e=this.tryEntries.length-1;0<=e;--e){var o=this.tryEntries[e],i=o.completion;if("root"===o.tryLoc)return t("end");if(o.tryLoc<=this.prev){var a=c.call(o,"catchLoc"),u=c.call(o,"finallyLoc");if(a&&u){if(this.prev<o.catchLoc)return t(o.catchLoc,!0);if(this.prev<o.finallyLoc)return t(o.finallyLoc)}else if(a){if(this.prev<o.catchLoc)return t(o.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return t(o.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;0<=n;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&c.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===t||"continue"===t)&&o.tryLoc<=e&&e<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=t,i.arg=e,o?(this.method="next",this.next=o.finallyLoc,m):this.complete(i)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),m},finish:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),S(n),m}},catch:function(t){for(var e=this.tryEntries.length-1;0<=e;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var o=r.arg;S(n)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,n){return this.delegate={iterator:P(t),resultName:e,nextLoc:n},"next"===this.method&&(this.arg=s),m}}}function w(t,e,n,r){var i,a,u,s,o=e&&e.prototype instanceof k?e:k,c=Object.create(o.prototype),l=new j(r||[]);return c._invoke=(i=t,a=n,u=l,s=h,function(t,e){if(s===d)throw new Error("Generator is already running");if(s===p){if("throw"===t)throw e;return N()}for(u.method=t,u.arg=e;;){var n=u.delegate;if(n){var r=L(n,u);if(r){if(r===m)continue;return r}}if("next"===u.method)u.sent=u._sent=u.arg;else if("throw"===u.method){if(s===h)throw s=p,u.arg;u.dispatchException(u.arg)}else"return"===u.method&&u.abrupt("return",u.arg);s=d;var o=b(i,a,u);if("normal"===o.type){if(s=u.done?p:f,o.arg===m)continue;return{value:o.arg,done:u.done}}"throw"===o.type&&(s=p,u.method="throw",u.arg=o.arg)}}),c}function b(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}function k(){}function x(){}function O(){}function _(t){["next","throw","return"].forEach(function(e){t[e]=function(t){return this._invoke(e,t)}})}function E(s){var e;this._invoke=function(n,r){function t(){return new Promise(function(t,e){!function e(t,n,r,o){var i=b(s[t],s,n);if("throw"!==i.type){var a=i.arg,u=a.value;return u&&"object"==typeof u&&c.call(u,"__await")?Promise.resolve(u.__await).then(function(t){e("next",t,r,o)},function(t){e("throw",t,r,o)}):Promise.resolve(u).then(function(t){a.value=t,r(a)},o)}o(i.arg)}(n,r,t,e)})}return e=e?e.then(t,t):t()}}function L(t,e){var n=t.iterator[e.method];if(n===s){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=s,L(t,e),"throw"===e.method))return m;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return m}var r=b(n,t.iterator,e.arg);if("throw"===r.type)return e.method="throw",e.arg=r.arg,e.delegate=null,m;var o=r.arg;return o?o.done?(e[t.resultName]=o.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=s),e.delegate=null,m):o:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,m)}function C(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function S(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function j(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(C,this),this.reset(!0)}function P(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,r=function t(){for(;++n<e.length;)if(c.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=s,t.done=!0,t};return r.next=r}}return{next:N}}function N(){return{value:s,done:!0}}}(function(){return this}()||Function("return this")()),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.CommentPlugin=e()}(this,function(){"use strict";!function(t){if(t&&"undefined"!=typeof window){var e=document.createElement("style");e.setAttribute("type","text/css"),e.innerHTML=t,document.head.appendChild(e)}}(".inline-comment, .frame-comment {\n  color: black;\n  padding: 12px;\n  font-size: 140%;\n  color: white;\n  position: absolute;\n  cursor: move;\n  border-radius: 16px; }\n  .inline-comment:focus, .frame-comment:focus {\n    outline: none;\n    border-color: #ffd92c; }\n\n.inline-comment {\n  z-index: 4;\n  background: #aec4ff;\n  border: 3px solid #aec4ff; }\n\n.frame-comment {\n  z-index: -10;\n  background: rgba(15, 80, 255, 0.2);\n  border: 6px solid transparent; }\n");var i=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},e=function(){function r(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(t,e,n){return e&&r(t.prototype,e),n&&r(t,n),t}}(),n=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},o=function t(e,n,r){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(void 0===o){var i=Object.getPrototypeOf(e);return null===i?void 0:t(i,n,r)}if("value"in o)return o.value;var a=o.get;return void 0!==a?a.call(r):void 0},a=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},u=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},c=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],r=!0,o=!1,i=void 0;try{for(var a,u=t[Symbol.iterator]();!(r=(a=u.next()).done)&&(n.push(a.value),!e||n.length!==e);r=!0);}catch(t){o=!0,i=t}finally{try{!r&&u.return&&u.return()}finally{if(o)throw i}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},s=function(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)},l=function(){function o(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:function(){},n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:function(){},r=3<arguments.length&&void 0!==arguments[3]?arguments[3]:function(){};i(this,o),this.mouseStart=null,this.el=t,this.onStart=e,this.onTranslate=n,this.onDrag=r,this.initEvents(t)}return e(o,[{key:"initEvents",value:function(t){t.addEventListener("mousedown",this.down.bind(this)),window.addEventListener("mousemove",this.move.bind(this)),window.addEventListener("mouseup",this.up.bind(this)),t.addEventListener("touchstart",this.down.bind(this)),window.addEventListener("touchmove",this.move.bind(this),{passive:!1}),window.addEventListener("touchend",this.up.bind(this))}},{key:"getCoords",value:function(t){var e=t.touches?t.touches[0]:t;return[e.pageX,e.pageY]}},{key:"down",value:function(t){t.stopPropagation(),this.mouseStart=this.getCoords(t),this.onStart()}},{key:"move",value:function(t){if(this.mouseStart){t.preventDefault(),t.stopPropagation();var e=this.getCoords(t),n=c(e,2),r=n[0],o=n[1],i=[r-this.mouseStart[0],o-this.mouseStart[1]],a=this.el.getBoundingClientRect().width/this.el.offsetWidth;this.onTranslate(i[0]/a,i[1]/a)}}},{key:"up",value:function(){this.mouseStart&&this.onDrag(),this.mouseStart=null}}]),o}(),h=function(){function r(t,e){var n=this;i(this,r),this.editor=e,this.text=t,this.scale=1,this.x=0,this.y=0,this.dragPosition=[0,0],this.links=[],this.el=document.createElement("div"),this.el.tabIndex=1,this.el.addEventListener("contextmenu",this.onClick.bind(this)),this.el.addEventListener("focus",this.onFocus.bind(this)),this.el.addEventListener("blur",this.onBlur.bind(this)),new l(this.el,function(){return n.onStart()},function(t,e){return n.onTranslate(t,e)}),this.update()}return e(r,[{key:"linkTo",value:function(t){this.links=t||[]}},{key:"linkedTo",value:function(t){return this.links.includes(t.id)}},{key:"k",value:function(){return 1}},{key:"onClick",value:function(t){t.preventDefault(),t.stopPropagation();var e=prompt("Comment",this.text);e&&(this.text=e,this.update())}},{key:"onFocus",value:function(){this.scale=Math.max(1,1/this.k()),this.update(),this.editor.trigger("commentselected",this)}},{key:"focused",value:function(){return document.activeElement===this.el}},{key:"onBlur",value:function(){this.scale=1,this.update()}},{key:"blur",value:function(){this.el.blur()}},{key:"onStart",value:function(){this.dragPosition=[this.x,this.y]}},{key:"onTranslate",value:function(t,e){var n=c(this.dragPosition,2),r=n[0],o=n[1];this.x=r+this.scale*t,this.y=o+this.scale*e,this.update()}},{key:"update",value:function(){this.el.innerText=this.text,this.el.style.transform="translate("+this.x+"px, "+this.y+"px) scale("+this.scale+")"}},{key:"toJSON",value:function(){return{text:this.text,position:[this.x,this.y],links:this.links}}}]),r}(),w=function(t){return 0===t.length?0:Math.min.apply(Math,s(t))},b=function(t){return 0===t.length?0:Math.max.apply(Math,s(t))};var f=function(t){function r(t,e){i(this,r);var n=u(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t,e));return n.width=0,n.height=0,n.links=[],n.el.className="frame-comment",n}return a(r,h),e(r,[{key:"linkedNodesView",value:function(){var n=this;return this.links.map(function(e){return n.editor.nodes.find(function(t){return t.id===e})}).map(function(t){return n.editor.view.nodes.get(t)})}},{key:"onStart",value:function(){o(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"onStart",this).call(this),this.linkedNodesView().map(function(t){return t.onStart()})}},{key:"onTranslate",value:function(e,n){o(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"onTranslate",this).call(this,e,n),this.linkedNodesView().map(function(t){return t.onDrag(e,n)})}},{key:"isContains",value:function(t){var e,n,r=this.el.getBoundingClientRect(),o=this.editor.view.nodes.get(t);return e=r,(n=o.el.getBoundingClientRect()).left>e.left&&n.right<e.right&&n.top>e.top&&n.bottom<e.bottom}},{key:"update",value:function(){o(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"update",this).call(this),this.el.style.width=this.width+"px",this.el.style.height=this.height+"px"}},{key:"toJSON",value:function(){return n({},o(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"toJSON",this).call(this),{type:"frame",width:this.width,height:this.height})}}]),r}(),d=function(t){function r(t,e){i(this,r);var n=u(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,t,e));return n.el.className="inline-comment",n.el.addEventListener("mouseup",n.onDrag.bind(n)),n}return a(r,h),e(r,[{key:"onDrag",value:function(){var t=this.getIntersectNode();this.linkTo(t?[t.node.id]:[])}},{key:"getIntersectNode",value:function(){var o=this.el.getBoundingClientRect();return Array.from(this.editor.view.nodes).map(function(t){var e=c(t,2);return{node:e[0],rect:e[1].el.getBoundingClientRect()}}).find(function(t){var e,n,r=t.rect;return e=o,!((n=r).left>e.right||n.right<e.left||n.top>e.bottom||n.bottom<e.top)})}},{key:"offset",value:function(t,e){this.x+=t,this.y+=e,this.update()}},{key:"toJSON",value:function(){return n({},o(r.prototype.__proto__||Object.getPrototypeOf(r.prototype),"toJSON",this).call(this),{type:"inline"})}}]),r}(),r=function(){function n(t){var e=this;i(this,n),this.editor=t,this.comments=[],t.on("zoomed",function(){e.comments.map(function(t){return t.blur.call(t)})})}return e(n,[{key:"addInlineComment",value:function(t,e){var n=this,r=c(e,2),o=r[0],i=r[1],a=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[],u=new d(t,this.editor);u.k=function(){return n.editor.view.area.transform.k},u.x=o,u.y=i,u.linkTo(a),this.addComment(u)}},{key:"addFrameComment",value:function(t,e){var n=c(e,2),r=n[0],o=n[1],i=2<arguments.length&&void 0!==arguments[2]?arguments[2]:[],a=3<arguments.length&&void 0!==arguments[3]?arguments[3]:0,u=4<arguments.length&&void 0!==arguments[4]?arguments[4]:0,s=new f(t,this.editor);s.x=r,s.y=o,s.width=a,s.height=u,s.linkTo(i),this.addComment(s)}},{key:"addComment",value:function(t){t.update(),this.comments.push(t),this.editor.view.area.appendChild(t.el),this.editor.trigger("commentcreated",t)}},{key:"deleteComment",value:function(t){this.editor.view.area.removeChild(t.el),this.comments.splice(this.comments.indexOf(t),1),this.editor.trigger("commentremoved",t)}},{key:"deleteFocusedComment",value:function(){var t=this.comments.find(function(t){return t.focused()});t&&this.deleteComment(t)}},{key:"toJSON",value:function(){return this.comments.map(function(t){return t.toJSON()})}},{key:"fromJSON",value:function(t){var e=this;[].concat(s(this.comments)).map(function(t){return e.deleteComment(t)}),t.map(function(t){"frame"===t.type?e.addFrameComment(t.text,t.position,t.links,t.width,t.height):e.addInlineComment(t.text,t.position,t.links)})}}]),n}();return{install:function(v,t){var e=t.margin,y=void 0===e?30:e;v.bind("commentselected"),v.bind("commentcreated"),v.bind("commentremoved");var g=new r(v);window.addEventListener("keydown",function(t){if("KeyF"===t.code&&t.shiftKey){var e=v.selected.list.map(function(t){return t.id}),n=e.map(function(e){return v.nodes.find(function(t){return t.id===e})}),r=(c=v,h=y,f=w((l=n).map(function(t){return t.position[0]}))-h,d=w(l.map(function(t){return t.position[1]}))-h,p=b(l.map(function(t){return t.position[0]+c.view.nodes.get(t).el.clientWidth}))+2*h,m=b(l.map(function(t){return t.position[1]+c.view.nodes.get(t).el.clientHeight}))+2*h,{left:f,right:p,top:d,bottom:m,width:Math.abs(f-p),height:Math.abs(d-m),getCenter:function(){return[(f+p)/2,(d+m)/2]}}),o=r.left,i=r.top,a=r.width,u=r.height;g.addFrameComment("...",[o,i],e,a,u)}else if("KeyC"===t.code&&t.shiftKey){var s=Object.values(v.view.area.mouse);g.addInlineComment("...",s)}else"Delete"===t.code&&g.deleteFocusedComment();var c,l,h,f,d,p,m}),v.on("nodetranslated",function(t){var e=t.node,n=t.prev,r=e.position[0]-n[0],o=e.position[1]-n[1];g.comments.filter(function(t){return t instanceof d}).filter(function(t){return t.linkedTo(e)}).map(function(t){return t.offset(r,o)})}),v.on("nodedraged",function(r){g.comments.filter(function(t){return t instanceof f}).filter(function(t){var e=t.isContains(r),n=t.links.filter(function(t){return t!==r.id});t.links=e?[].concat(s(n),[r.id]):n})}),v.on("commentselected",function(){var t=[].concat(s(v.selected.list));v.selected.clear(),t.map(function(t){return t.update?t.update():null})}),v.on("export",function(t){t.comments=g.toJSON()}),v.on("import",function(t){g.fromJSON(t.comments||[])})}}});
//# sourceMappingURL=comment-plugin.min.js.map
